<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Towers by Province</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body, html {
            height: 100%;
            margin: 0;
            background-color: #f8f9fa;
        }

        #map {
            width: 100%;
            height: 80vh;
        }

        .form-container {
            background-color: #fff;
            padding: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        select.form-select {
            font-size: 0.9rem;
        }

        .thumbnail {
            max-width: 80px;
            max-height: 80px;
            display: block;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="form-container container-fluid">
    <div class="row g-2">
        <div class="col-12 col-md-6">
            <label for="provinceSelect">Province</label>
            <select id="provinceSelect" class="form-select">
                <option value="">Select Province</option>
                {% for province in provinces %}
                <option value="{{ province.id }}">{{ province.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 col-md-6">
            <label for="towerSelect">Tower</label>
            <select id="towerSelect" class="form-select">
                <option value="">Select Tower</option>
                <!-- Populated dynamically -->
            </select>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
let map;
let userLocation;
let towerMarkers = [];

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: {lat: 12.8797, lng: 121.7740} // Philippines center
    });

    // Detect user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: "Your Location",
                    icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                });

                map.setCenter(userLocation);
                map.setZoom(12);
            },
            function(err) { console.warn("Geolocation failed."); },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }

    const provinceSelect = document.getElementById("provinceSelect");
    const towerSelect = document.getElementById("towerSelect");

    provinceSelect.addEventListener("change", function() {
        const provinceId = this.value;

        towerSelect.innerHTML = "<option value=''>Select Tower</option>";

        towerMarkers.forEach(marker => marker.setMap(null));
        towerMarkers = [];

        if (!provinceId) return;

        fetch(`/api/towers_by_province/${provinceId}/`)
        .then(res => res.json())
        .then(data => {
            data.forEach(tower => {
                const opt = document.createElement("option");
                opt.value = JSON.stringify(tower);
                opt.textContent = tower.name;
                towerSelect.appendChild(opt);

                const towerPos = { lat: tower.latitude, lng: tower.longitude };

                const marker = new google.maps.Marker({
                    position: towerPos,
                    map: map,
                    title: tower.name,
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    label: { text: tower.name, color: "blue", fontWeight: "bold", fontSize: "12px" }
                });

                let imgHtml = '';
                if(tower.picture_url){
                    imgHtml = `<a href="${tower.picture_url}" target="_blank">
                        <img src="${tower.picture_url}" class="thumbnail" alt="${tower.name}">
                    </a>`;
                }

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="font-size:0.9rem;">
                            <b>${tower.name}</b><br>
                            Province: ${tower.province}<br>
                            City/Municipality: ${tower.city}<br>
                            Barangay: ${tower.barangay}<br>
                            Lat: ${tower.latitude}<br>
                            Lng: ${tower.longitude}<br>
                            ${imgHtml}
                            <a href="https://www.google.com/maps/dir/?api=1&origin=${userLocation ? userLocation.lat + ',' + userLocation.lng : tower.latitude + ',' + tower.longitude}&destination=${tower.latitude},${tower.longitude}&travelmode=driving" target="_blank" style="color:#4f46e5; font-weight:bold;">Get Directions</a>
                        </div>
                    `
                });

                marker.addListener("click", function() {
                    infoWindow.open(map, marker);
                });

                towerMarkers.push(marker);
            });

            if (data.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                towerMarkers.forEach(m => bounds.extend(m.getPosition()));
                map.fitBounds(bounds);
            }
        });
    });

    towerSelect.addEventListener("change", function() {
        const val = this.value;
        if (!val) return;

        const tower = JSON.parse(val);

        const towerPos = { lat: tower.latitude, lng: tower.longitude };

        map.setCenter(towerPos);
        map.setZoom(14);

        // Optional: highlight only selected tower
        towerMarkers.forEach(m => m.setMap(null));
        const marker = new google.maps.Marker({
            position: towerPos,
            map: map,
            title: tower.name,
            icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
            label: { text: tower.name, color: "blue", fontWeight: "bold", fontSize: "12px" }
        });

        let imgHtml = '';
        if(tower.picture_url){
            imgHtml = `<a href="${tower.picture_url}" target="_blank">
                        <img src="${tower.picture_url}" class="thumbnail" alt="${tower.name}">
                    </a>`;
        }

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div style="font-size:0.9rem;">
                    <b>${tower.name}</b><br>
                    Province: ${tower.province}<br>
                    City/Municipality: ${tower.city}<br>
                    Barangay: ${tower.barangay}<br>
                    Lat: ${tower.latitude}<br>
                    Lng: ${tower.longitude}<br>
                    ${imgHtml}
                    <a href="https://www.google.com/maps/dir/?api=1&origin=${userLocation ? userLocation.lat + ',' + userLocation.lng : tower.latitude + ',' + tower.longitude}&destination=${tower.latitude},${tower.longitude}&travelmode=driving" target="_blank" style="color:#4f46e5; font-weight:bold;">Get Directions</a>
                </div>
            `
        });

        marker.addListener("click", function() {
            infoWindow.open(map, marker);
        });

        towerMarkers = [marker];
    });
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAp38ahRHi7YSU7iDITGyvJSHT6uo8-RFE&callback=initMap&v=weekly" 
        async defer></script>
<script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
