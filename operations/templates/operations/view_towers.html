{% extends 'operations/base.html' %}

{% block title %}View Towers - SIMOS{% endblock %}

{% block content %}
<div class="container-main px-3 pt-3">
    <h2 class="header-title text-center mb-4">View Towers by Province</h2>

    <!-- Filter Panel -->
    <div class="form-container mb-3">
        <div class="row g-2">

            <!-- Province -->
            <div class="col-md-3 col-12">
                <label for="provinceSelect">Province</label>
                <select id="provinceSelect" class="form-select">
                    <option value="">Select Province</option>
                    {% for province in provinces %}
                    <option value="{{ province.id }}">{{ province.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- City -->
            <div class="col-md-3 col-12">
                <label for="citySelect">City | Municipality</label>
                <select id="citySelect" class="form-select">
                    <option value="">Select City</option>
                </select>
            </div>

            <!-- Barangay -->
            <div class="col-md-3 col-12">
                <label for="barangaySelect">Barangay</label>
                <select id="barangaySelect" class="form-select">
                    <option value="">Select Barangay</option>
                </select>
            </div>

            <!-- Tower -->
            <div class="col-md-3 col-12">
                <label for="towerSelect">Tower</label>
                <select id="towerSelect" class="form-select">
                    <option value="">Select Tower</option>
                </select>
            </div>

        </div>
    </div>

    <!-- Map -->
    <div id="map" style="width:100%; height:70vh; border-radius:15px; box-shadow:0 6px 18px rgba(0,0,0,0.15);"></div>

    <!-- Directions & Details Buttons -->
    <div class="mt-3 mb-4 d-flex flex-column gap-2">
        <a id="directionsBtn" href="#" target="_blank" class="btn btn-direction d-none">
            üöó Get Directions in Google Maps
        </a>
        <a id="detailsBtn" href="#" class="btn btn-outline-primary d-none">
            üìÑ View Tower Details
        </a>
    </div>

</div>

{% if messages %}
<div class="container mb-3">
    {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- Styles -->
<style>
.header-title { font-weight: 700; font-size: 1.6rem; color: #374151; }
.form-container { background: white; padding:20px; border-radius:15px; box-shadow:0 6px 18px rgba(0,0,0,0.15); }
label { font-weight: 600; color:#3b82f6; }
.btn-direction { background: linear-gradient(90deg,#2563eb,#4f46e5); color:white; border-radius:50px; }
.tower-thumb { width:100px; height:100px; object-fit:cover; border-radius:8px; }
</style>

<!-- Google Map + Dropdown Logic -->
<script>
let map, userLocation, towerMarker;

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: {lat: 12.8797, lng: 121.7740}
    });

    /* Try get user location */
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    title: "You Are Here"
                });
                map.setCenter(userLocation);
                map.setZoom(13);
            }
        );
    }

    const provinceSelect = document.getElementById("provinceSelect");
    const citySelect = document.getElementById("citySelect");
    const barangaySelect = document.getElementById("barangaySelect");
    const towerSelect = document.getElementById("towerSelect");

    const directionsBtn = document.getElementById("directionsBtn");
    const detailsBtn = document.getElementById("detailsBtn");

    /* --------------------------
       1Ô∏è‚É£ PROVINCE ‚Üí CITIES
    ---------------------------- */
    provinceSelect.addEventListener("change", () => {
        citySelect.innerHTML = "<option value=''>Select City</option>";
        barangaySelect.innerHTML = "<option value=''>Select Barangay</option>";
        towerSelect.innerHTML = "<option value=''>Select Tower</option>";

        if (!provinceSelect.value) return;

        fetch(`/api/cities_by_province/${provinceSelect.value}/`)
        .then(res => res.json())
        .then(data => {
            data.forEach(city => {
                citySelect.innerHTML += `<option value="${city.id}">${city.name}</option>`;
            });
        });
    });

    /* --------------------------
       2Ô∏è‚É£ CITY ‚Üí BARANGAYS
    ---------------------------- */
    citySelect.addEventListener("change", () => {
        barangaySelect.innerHTML = "<option value=''>Select Barangay</option>";
        towerSelect.innerHTML = "<option value=''>Select Tower</option>";

        if (!citySelect.value) return;

        fetch(`/api/barangays_by_city/${citySelect.value}/`)
        .then(res => res.json())
        .then(data => {
            data.forEach(brgy => {
                barangaySelect.innerHTML += `<option value="${brgy.id}">${brgy.name}</option>`;
            });
        });
    });

    /* --------------------------
       3Ô∏è‚É£ BARANGAY ‚Üí TOWERS
    ---------------------------- */
    barangaySelect.addEventListener("change", () => {
        towerSelect.innerHTML = "<option value=''>Select Tower</option>";

        if (!barangaySelect.value) return;

        fetch(`/api/towers_by_barangay/${barangaySelect.value}/`)
        .then(res => res.json())
        .then(data => {
            data.forEach(tower => {
                towerSelect.innerHTML += `<option value='${JSON.stringify(tower)}'>${tower.name}</option>`;
            });
        });
    });

    /* --------------------------
       4Ô∏è‚É£ SELECT TOWER ‚Üí SHOW MAP
    ---------------------------- */
    towerSelect.addEventListener("change", function() {
        if (!this.value) return;

        const tower = JSON.parse(this.value);
        const towerPos = { lat: tower.latitude, lng: tower.longitude };

        if (towerMarker) towerMarker.setMap(null);

        towerMarker = new google.maps.Marker({
            position: towerPos,
            map: map,
            icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            title: tower.name
        });

        let imgHtml = tower.picture_url ?
            `<a href="${tower.picture_url}" target="_blank"><img src="${tower.picture_url}" class="tower-thumb"></a>` :
            "No image";

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div style="text-align:center">
                    <b>${tower.name}</b><br><br>
                    ${imgHtml}<br><br>
                    <small>Status: ${tower.status}</small><br><br>
                    {% if can_bicto %}
                        <a href="/update-bicto/${tower.id}/" class="btn btn-sm btn-info">Update BICTO</a><br><br>
                    {% endif %}

                    {% if user_can_update %}
                        <a href="/update-construction/${tower.id}/" class="btn btn-sm btn-secondary">Update Construction</a><br><br>
                    {% endif %}

                    {% if can_electric %}
                        <a href="/update-electrical/${tower.id}/" class="btn btn-sm btn-warning">Update Electrical</a><br><br>
                    {% endif %}

                    {% if can_power_up %}
                        <a href="/update-instrumentation/${tower.id}/" class="btn btn-sm btn-primary">Update Instrumentation</a>
                    {% endif %}
                </div>
            `
        });

        infoWindow.open(map, towerMarker);
        map.setCenter(towerPos);
        map.setZoom(15);

        /* Directions */
        if (userLocation) {
            directionsBtn.href =
                `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${tower.latitude},${tower.longitude}`;
            directionsBtn.classList.remove("d-none");
        }

        /* Details Button */
        detailsBtn.href = `/tower-details/${tower.id}/`;
        detailsBtn.classList.remove("d-none");
    });
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAp38ahRHi7YSU7iDITGyvJSHT6uo8-RFE&callback=initMap&v=weekly" async defer></script>
{% endblock %}
